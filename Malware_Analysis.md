# Malware Analysis Cheat Sheet

## 1. Lab Environment

### Virtual Machine Setup
- **VM Software:** VMWare Workstation, Oracle VM VirtualBox
- **Guest OS:** Windows 10
- **Configurations:**
  - Disable Windows Update
  - Disable Windows Defender
  - Enable Filename Extensions
  - Show Hidden Files & Folders
- **Tools:**
  - [FlareVM](https://github.com/mandiant/flare-vm) (for automated software installation)


## 2. File and File Formats

### Tools
- **HxD** (Hex Editor)
- **TrID** (File Type Identification)
  ```bash
  trid.exe FILENAME
  ```


## 3. Portable Executable (PE) File

### Process Analysis Tools
- **Process Hacker** – View running processes
- **ProcMon** – Monitor file system and registry activity

### Process Attributes
- **Process Name:** Not unique; one PE file can create multiple processes.
- **PID (Process ID):** Unique identifier, assigned randomly.
- **PPID (Parent Process ID):** Indicates the parent process.
- **RAM:** Volatile storage for active processes.
- **Virtual Memory:** Uses HDD/SSD as extended RAM.

### Memory Types
- **Private:** Not shared (allocated via `VirtualAlloc()`)
- **Mapped:** Pointer to file on disk
- **Images:** Loaded executables and DLLs
- **Commit & Reserved:** Allocated memory regions

### Memory Protections
- **Read, Write, Execute (RWX)** – Used for exploitation
- **Strings Search** – Extract strings using Process Hacker

### PE File Structure
- MZ DOS Header → DOS Stub → PE Header → Section Table → Section Data
- **CFF Explorer** – Analyze PE headers
- **DLL Files:** Contain functions used by other files, cannot execute alone.


## 4. Windows Internals

### System DLLs
- **Location:** `C:\Windows\System32`
- **Documentation:** Search MSDN
- **Native APIs:** Found at [undocumented.ntinternals.net](http://undocumented.ntinternals.net/)
- **NTCreateSection:** Used for process hollowing

### Common API Calls in Malware
- **File Operations:** `CreateFile`, `WriteFile`, `ReadFile`, `DeleteFile`
- **Registry Operations:** `RegCreateKey`, `RegDeleteKey`, `RegSetValue`
- **Memory Operations:** `VirtualAlloc`, `VirtualProtect`, `NtCreateSection`, `WriteProcessMemory`
- **Process & Threads:** `CreateProcess`, `CreateRemoteThread`, `TerminateProcess`
- **DLL Loading:** `LoadLibrary`, `GetProcAddress`
- **Services:** `OpenSCManager`, `CreateService`, `StartService`
- **Mutex:** `CreateMutex`, `OpenMutex`

### Suspicious Behavior
- **Suspended Process Creation:** `CreateProcess(dwCreationFlag = CREATE_SUSPENDED)` creates a suspended process and could indicate Process Hollowing
- **Memory Injection:** `WriteProcessMemory + VirtualAllocEx + CreateRemoteThread`
- **Handles:** Handles are refernces to files, registry, memory and processes. It can indicate malicious behavior.


## 5. Static Analysis

### Tools
- **TrIDNet / ExePEInfo** – Identify file type
- **Bintext / Strings** – Extract plaintext strings
- **XorSearch** – Find encrypted strings
- **CFF Explorer / PE Studio** – Examine PE headers
- **HashMyFile** – Generate hashes for VirusTotal lookup

### Workflow
1. **TrIDNet** – Identify file type
2. **PEStudio**
   - Indicators of compromise
   - Strings analysis (blacklisted strings)
   - Import analysis (registry, file, network calls)
3. **HashMyFile** – Check hash against VirusTotal


## 6. Dynamic Analysis

### Goals
- Monitor changes in files, processes, and registry
- Observe malware behavior in a controlled environment

### Tools
- **Regshot** – Compare registry snapshots
- **Autoruns** – Identify persistence mechanisms
- **Fakenet** – Simulate C2 communication
- **Wireshark** – Analyze network traffic
- **ProcMon** – Track process and registry changes
- **Procdot** – Visualize process behavior (requires Procmon log)

### Key Indicators
- **File System Modifications**
- **Registry Changes**
- **Network Activity**
- **Persistence Mechanisms**
- **Process Launch Events**

### Workflow
#### Pre-Execution
1. Start **Procmon**, pause & clear logs
2. Start **Fakenet**
3. Take first **Regshot**

#### Execution & Capture
4. Resume **Procmon**, execute malware, wait
5. Pause **Procmon**
6. Take second **Regshot**, compare results

#### Analysis
- **Procmon Filters:**
  - `Process Name` → Malware executable
  - **Operations to Monitor:**
    - `CreateFile`, `WriteFile`, `ReadFile`
    - `RegCreateKey`, `RegSetValue`, `RegDeleteKey`
    - `ProcessCreate`, `ProcessStart`
    - `TCP`, `UDP` network events


## 7. Registry Persistence

### Startup Keys
- `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
- `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`
- `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`

### Services & Drivers
- `HKLM\SYSTEM\CurrentControlSet\Services` (Malicious service)

### Scheduled Tasks
- `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Schedule\TaskCache\Tree`

### Userinit & Shell Hijacking
- `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Userinit`
- `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Winlogon\Shell`

### Image File Execution Options (IFEO)
- `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options\[target.exe]`

### DLL Injection via AppInit
- `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Windows\AppInit_DLLs`

### Active Setup
- `HKLM\Software\Microsoft\Active Setup\Installed Components\[GUID]`

### WMI Persistence
- `HKLM\SOFTWARE\Microsoft\WBEM\CIMOM`

### COM Object Hijacking
- `HKCR\CLSID\[GUID]\InProcServer32`

### Boot Execute
- `HKLM\SYSTEM\CurrentControlSet\Control\Session Manager\BootExecute`


## 8. Additional Tools
- **MalwareJail** – JavaScript sandbox
- **Kerbrute** – Kerberos enumeration


## 9. References
- [MSDN API Documentation](https://docs.microsoft.com/en-us/windows/win32/api/)
- [Undocumented Windows APIs](http://undocumented.ntinternals.net/)
- [FlareVM](https://github.com/mandiant/flare-vm)
- [VirusTotal](https://www.virustotal.com/gui/home/upload)

